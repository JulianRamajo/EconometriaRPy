---
title: 'TEMA 3: Información muestral: Falta de observaciones (missing data)'
author:
  name: Julián Ramajo, ramajo@unex.es
  affiliation: GRADO EN ESTADÍSTICA | ECONOMETRIA (502243)
subtitle: 'Aplicación 3.9: Exclusión social en el comportamiento de las aseguradoras de Chicago'
output:
  html_document:
    theme: journal
    highlight: haddock
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

# Objetivo

En esta aplicación se usarán los datos de un estudio de la década de 1970 sobre la relación entre la exclusión social de los seguros y la composición racial, los índices de incendio y robo, la antigüedad de las viviendas y los ingresos en 47 distritos postales de Chicago.

# Resultados R

```{r, message=FALSE}
# Lectura de datos
library(faraway)
# help(chredlin, package="faraway")
data(chmiss, package="faraway")
chmiss
summary(chmiss)
# Detección de datos perdidos
# Por filas
rowSums(is.na(chmiss))
image(is.na(chmiss),axes=FALSE)
axis(2, at=0:5/5, labels=colnames(chmiss),las=2)
axis(1, at=0:46/46, labels=row.names(chmiss),las=2)
# Por columnas
colSums(is.na(chmiss))
library(mi)
md <- missing_data.frame(chmiss)
image(md)
summary(md@patterns)
# Tratamiento de datos perdidos
# Omisión de los datos perdidos (opción por defecto en R): resultados con los datos completos
mod_1 <- lm(involact ~ race+fire+theft+age+log(income), chmiss)
summary(mod_1)
# Imputación simple: uso de la media para predecir los datos faltantes de las variables explicativas
(cmeans <- colMeans(chmiss,na.rm=TRUE))
imput_1 <- chmiss
for(i in c(1:4,6)) imput_1[is.na(chmiss[,i]),i] <- cmeans[i]    # Sólo se rellenan los valores perdidos de las var. expl.
#
mod_2 <- lm(involact ~ race+fire+theft+age+log(income), imput_1)
summary(mod_2)
# Imputación más elaborada: usar regresiones para predecir los datos faltantes de las variables explicativas
mod_race <- lm(race ~ fire+theft+age+income,chmiss)
chmiss[is.na(chmiss$race),]
predict(mod_race,chmiss[is.na(chmiss$race),])
# Como la predicción para la zona 60646 es negativa, se puede usar la tranformación logit ( log(y/(1-y)) )
# para evitar que las predicciones se salgan del intervalo [0,1] y luego aplicar la transformación inversa 
# a la predicción
mod_race_2 <- lm(logit(race/100) ~ fire+theft+age+income,chmiss)
ilogit(predict(mod_race_2,chmiss[is.na(chmiss$race),]))*100
#
mod_fire <- lm(fire ~ race+theft+age+income,chmiss)
chmiss[is.na(chmiss$fire),]
predict(mod_fire,chmiss[is.na(chmiss$fire),])
#
mod_theft <- lm(theft ~ race+fire+age+income,chmiss)
chmiss[is.na(chmiss$theft),]
predict(mod_theft,chmiss[is.na(chmiss$theft),])
#
mod_age <- lm(age ~ race+fire+theft+income,chmiss)
chmiss[is.na(chmiss$age),]
predict(mod_age,chmiss[is.na(chmiss$age),])
#
mod_income <- lm(income ~ race+fire+theft+age,chmiss)
chmiss[is.na(chmiss$income),]
predict(mod_income,chmiss[is.na(chmiss$income),])
# Generación de valores para los datos perdidos por variable
imput_2  <- chmiss
imput_2$race[is.na(chmiss$race)] <- ilogit(predict(mod_race_2,chmiss[is.na(chmiss$race),]))*100
imput_2$fire[is.na(chmiss$fire)] <- predict(mod_fire,chmiss[is.na(chmiss$fire),])
imput_2$theft[is.na(chmiss$theft)] <-  predict(mod_theft,chmiss[is.na(chmiss$theft),])
imput_2$age[is.na(chmiss$age)] <-  predict(mod_age,chmiss[is.na(chmiss$age),])
imput_2$income[is.na(chmiss$income)] <-  predict(mod_income,chmiss[is.na(chmiss$income),])
#
mod_3 <- lm(involact ~ race+fire+theft+age+log(income), imput_2)
summary(mod_3)
# Imputación múltiple (Enfoque AMELIA II)
require(Amelia)
imput_3 <- amelia(chmiss, m=25)
summary(imput_3)
#
betas <- NULL
se_betas <- NULL
for(i in 1:imput_3$m){
  lmod <- lm(involact ~ race+fire+theft+age+log(income), imput_3$imputations[[i]])
  betas <- rbind(betas ,coef(lmod))
  se_betas <- rbind(se_betas ,coef(summary(lmod))[,2])
}
# Estimaciones, desviaciones estándar estimadas y estadísticos t (individuales y combinadas)
betas; se_betas
(cr <- mi.meld(q=betas,se=se_betas))
(cr$q.mi/cr$se.mi)
# Imputación múltiple (Enfoque MICE)
library(mice)
# Patrón de datos perdidos
md.pattern(chmiss)
# Imputación simple con la media de los datos completos
imp_4_0 <- mice(chmiss, method = "mean", m = 1, maxit = 1)
imput_1_2 <- complete(imp_4_0) # Se obtiene el mismo resultado que en el fichero imput_1, pera también se imputan
summary(with(imput_1_2, lm(involact ~ race+fire+theft+age+log(income))))  # los valores perdidos de la variable dependiente
# Imputación por el método de regresión (1)
imp_4_1 <- mice(chmiss, method = "norm.predict", m = 1, maxit = 1) # Predicción simple
imput_2_1 <- complete(imp_4_1) # Comparar con el fichero imput_2
# Imputación por el método de regresión (2)
imp_4_2 <- mice(chmiss, method = "norm.nob", m = 1, maxit = 1) # Predicción estocástica (se añade un error aleatorio)
imput_2_2 <- complete(imp_4_2) # Comparar con el fichero imput_2
# Imputación por el método de regresión (3)
imp_4_3 <- mice(chmiss, method = "norm.boot", m = 1, maxit = 1) # Predicción usando booostrap
imput_2_3 <- complete(imp_4_3) # Comparar con el fichero imput_2
# 
# Imputación múltipe con mice 
imp_4 <- mice(chmiss, m = 25, print=F)
summary(imp_4)
class(imp_4) # mids: multiply imputed data set
attributes(imp_4)
# Para ver los datos imputados de una variable
imp_4$imp # Todas las imputaciones
imp_4$imp$race # Imputaciones para una variable: cambiar race por otra variable para ver el resultado
# Para guardar los datos completos de una imputación
imp_4_m_1 <- complete(imp_4,1) # cambiar 1 por cualquier valor entre 1 y 25
# Inspección de la calidad de las imputaciones
# Convergencia del algoritmo (iterative Markov Chain Monte Carlo)
plot(imp_4)
# Gráfica conjunta
stripplot(imp_4)
# Gráfica individual
stripplot(imp_4, involact, pch = 20, xlab = "Imputation number")
stripplot(imp_4, race, pch = 20, xlab = "Imputation number")
stripplot(imp_4, fire, pch = 20, xlab = "Imputation number")
stripplot(imp_4, theft, pch = 20, xlab = "Imputation number")
stripplot(imp_4, age, pch = 20, xlab = "Imputation number")
stripplot(imp_4, income, pch = 20, xlab = "Imputation number")
# Distribución de los datos completos y los completados
xyplot(imp_4,involact ~ race+fire+theft+age+income)
densityplot(imp_4)
# Ajsute de los modelos con los datos completados (m modelos)
fit <- with(imp_4, lm(involact ~ race+fire+theft+age+log(income)))
# Pool y resumen de resultados
fit # Para ver el resultado de la regresión para cada conjunto de datos imputados (m=25 en el ejemplo)
summary(fit$analyses[[1]]) # Para ver el resultado de una regresión concreta (la primera en el ejemplo)
summary(pool(fit))
# Comparación de los resultados a posteriori, con la muestra completa
data(chredlin, package="faraway")
mod_full <- lm(involact ~ race+fire+theft+age+log(income), chredlin)
summary(mod_full)
```
