---
title: 'Lectura, filtrado, selección, transformación y representación gráfica de datos en R con Tidyverse'
author:
  name: Julián Ramajo, ramajo@unex.es
  affiliation: GRADO EN ESTADÍSTICA | ECONOMETRIA (502243)
subtitle: 'Aplicación 1.3 (Tidyverse: https://www.tidyverse.org/): Gapminder [https://www.gapminder.org/tools] '
output:
  html_document:
    theme: journal
    highlight: haddock
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

# Código R

```{r}
library(tidyverse)
gapminder <- read_delim("GAPMINDER.csv", ";", escape_double = FALSE, trim_ws = TRUE)
head(gapminder)
#
# Operaciones básicas del Tidyverse
#
# Gramática de gráficas (ggplot2)
#
ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp)) + 
  geom_point()
#
ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp)) +  
  geom_point(aes(size = pop, col = continent), alpha = 0.3)
#
p = ggplot(data = gapminder, aes(x = gdpPercap, y = lifeExp))
p + 
  geom_point(alpha = 0.3)  +
  geom_smooth(method = "loess")
#
p + 
  geom_point(aes(size = pop, col = continent), alpha = 0.3)  +
  geom_smooth(method = "loess") 
#
ggplot(data = gapminder) + 
  geom_density(aes(x = gdpPercap), alpha=0.3)
#
ggplot(data = gapminder) + 
  geom_density(aes(x = gdpPercap, fill = continent), alpha=0.3)
#
p2 =
  p +
  geom_point(aes(size = pop, col = continent), alpha = 0.3) +
  scale_color_brewer(name = "Continent", palette = "Set1") + ## Diferente  escala de colores
  scale_size(name = "Population", labels = scales::comma) + ## Diferentes escala de puntos
  scale_x_log10(labels = scales::dollar) + ## Escala logarítmica en el eje X y unidades de $ 
  labs(x = "Log (GDP per capita)", y = "Life Expectancy") + ## Títulos en los ejes
  theme_minimal() ## minimal (b&w) plot theme
p2
#
library(gganimate)
ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  # scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10(labels = scales::dollar) +
  facet_wrap(~continent) +
  labs(title = 'Year: {frame_time}', x = 'Log (GDP per capita)', y = 'Life expectancy') +
  transition_time(year) +
  ease_aes('linear')
#
# Análisis exploratorio de datos (EDA)
#
library(skimr)
skim(gapminder)
#
# Gramática de datos (dplyr)
#
# "Verbos" de dplyr
#
# select
#
gapminder_selected <- select(gapminder, year, country, pop, gdpPercap)
#
# filter
#
gapminder_filtered <- filter(gapminder_selected, year>=1980)
#
# mutate
#
gapminder_mutated <- mutate(gapminder_filtered, GDP=gdpPercap*pop)
#
# group_by
#
gapminder_grouped <- group_by(gapminder_mutated, country)
#
# summarise
#
gapminder_summarised <- summarise(gapminder_grouped, AVG_GDP=mean(GDP))
#
# arrange
#
gapminder_arranged_ascending <- arrange(gapminder_summarised, AVG_GDP)
gapminder_arranged_descending <- arrange(gapminder_summarised, -AVG_GDP)
#
# El operador "tubería" (pipe) (%>%)
#
AVG_GDP <- 
  gapminder %>% 
  select(year, country, pop, gdpPercap) %>% 
  filter(year>=1980) %>% 
  mutate(GDP=gdpPercap*pop) %>% 
  group_by(country) %>% 
  summarise(AVG_GDP=mean(GDP)) %>% 
  arrange(-AVG_GDP)
#
# Más gráficas, regresión y diagnosis
#
# GGally 
#
library(GGally)
#
gapminder %>% select(-country) %>% ggpairs()
#
# Regresión
#
model_1 <- lm(lifeExp ~ log(gdpPercap) + year, data=gapminder)
summary(model_1)
#
ggplot(data = gapminder, aes(x = log(gdpPercap), y = lifeExp)) + 
    geom_smooth(method = "lm", col = "red") + 
    geom_point()
ggplot(data = gapminder, aes(x = year, y = lifeExp)) + 
    geom_smooth(method = "lm", col = "red") + 
    geom_point()
```
