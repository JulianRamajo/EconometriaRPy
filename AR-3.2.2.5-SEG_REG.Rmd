---
title: "SEG_REG"
output:
  html_document:
    df_print: paged
---

```{r}
#
library(tidyverse)
library(plotly)
# Lectura de datos: y = Total Construction Spending (TTLCON) [ https://fred.stlouisfed.org/series/TTLCON) ]
TCS <- read_csv("TTLCON_USA.csv") %>% setNames(c("date","y"))
head(TCS)
tail(TCS)
class(TCS)
str(TCS)
# Gráfica de los datos
plot_ly(data = TCS) %>% add_lines(x = ~ date, y = ~ y)
# Construcción de tendencias
TCS <- TCS %>%
  mutate(seg1 = 1:nrow(TCS),
         seg2 = pmax(0, seg1 - min(seg1[seg1[which(date > as.Date("2007-08-01"))]])),
         seg3 = pmax(0, seg1 - min(seg1[seg1[which(date > as.Date("2011-01-01"))]])))
# Modelo con tendencia simple
mod1 <- lm(y ~ seg1, data = TCS)
summary(mod1)
# Modelo con tendencias sementadas (con pivote conocido)
mod2 <- lm(y ~ seg1 + seg2 + seg3, data = TCS)
summary(mod2)
TCS$yhat1 <- predict(mod1)
TCS$yhat2 <- predict(mod2)
# Gráfica de los datos con las tendencias ajustadas por los dos modelos
plot_ly(data = TCS) %>%
  add_markers(x = ~ date,
              y = ~ y,
              marker = list(
                opacity = 0.6,
                color = "#90e0ef",
                size = 8),
              name = "Gasto en construcción") %>%
add_lines(x = ~ date,
          y = ~ yhat1,
          line = list(color = "red",
                      dash = "dash",
                      width = 4),
          name = "Tendencia simple") %>%
  add_lines(x = ~ date,
            y = ~ yhat2,
            line = list(color = "#fca311",
                        dash = "dot",
                        width = 6),
            name = "Tendencia segmentada") %>%
  layout(title = "Gasto total en construcción en USA",
         font = list(color = "black"),
         yaxis = list(title = "Millones de dólares"),
         xaxis = list(title = "Fuente: U.S. Census Bureau, Total Construction Spending, extraído de FRED (fred.stlouisfed.org)"),
         margin = list(t = 50, b = 80),
         legend = list(x = 0.05, y = 0.95))
#
```
