---
title: "IBEX35 modeling with R"
output: html_notebook
---


```{r, package import}
# for scraping
library(rvest)
# blanket import for core tidyverse packages
library(tidyverse)
# tidy financial analysis 
library(tidyquant)
# tidy data cleaning functions
library(janitor)
```

The next thing that I will do is define a variable with todays date.  I will then use the subtract 3 months from todays date.  This returns a another date object, indicating what day came 3 months before today.  I will need this because I want to get the last 3 months of OHLC data for each ticker.

```{r}
# save current system date to a variable
today <- Sys.Date()
# subtract 6 months from the current date
date = today %m+% months(-6)
print(date)
```

I'm going to use the tidyquant package to get the financial data for all SP500 tickers.  The tidyqunat packages core function is tq_get() which can be used to get various information about stocks.  If I pass a string containing a ticker name to tq_get(), it will return Open, High, Low, Close or OHLC data.

```{r}
# Pass IBEX35 ticker ^IBEX to tq_get function
IBEX35_ticker = tq_get("^IBEX", from = date)
IBEX35_ticker %>% 
  head()
IBEX35_ticker %>% 
  tail()
# Extract and visualize one of the assets raw prices over time
ticker = "^IBEX"
IBEX35_ticker %>% 
  filter(symbol == !!ticker) %>% 
  ggplot(aes(date, adjusted))+
  geom_line()
```

Theres a few things to note above:

* tq_get() returns a tidy dataframe
* the ticker name is not in the dataframe
* the '%>%' operator is called a pipe. It passes the object that proceeds it as the first argument to the function that follows it.

I want this OHLC data for all SP500 tickers. In order to do this I will need to do a few things:

* Get a list of all SP500 tickers
* Iterate over this list and call tq_get on each element of the list, returning a dataframe for each ticker
* combine all these dataframes into one dataframe 

Wow! That sounds a little complicated right? luckily, with R, going about this will be pretty simple.  Wikiepdia has a table of all 505 SP500 tickers (some companies, like Google, have multiple asset classes) located at this URL:

https://en.wikipedia.org/wiki/IBEX_35

To get all the SP500 tickers we are going to scrape this table, using the rvest package.  The Rvest package is a simple scraping package in R that is very similar to python's beautiful soup. In programming, scraping is defined as programatically collecting human readable content from the internent and webpages.

In the code below I scrape the wikipedia table and create a list of all SP500 tickers.  The hardest part of scraping is figuring out the xpath or css to indicate which html nodes to select. I really don't know much about html or css, but using Google Chrome I was able to find the correct xpath.  

¡No ejecuatar, no funcionan los tickers en Yahoo!

```{r}
# get the URL for the wikipedia page with all IBEX35 symbols
url <- "https://en.wikipedia.org/wiki/IBEX_35"
# use that URL to scrape the SP500 table using rvest
tickers <- url %>%
  # read the HTML from the webpage
  read_html() %>%
  # to get table
  html_nodes(xpath='//*[@id="mw-content-text"]/div[1]/table[2]') %>%
  html_table()
#create a list of tickers
IBEX35_tickers <- tickers[[1]]
IBEX35_tickers = IBEX35_tickers %>% mutate(Ticker = case_when(TRUE ~ as.character(Ticker)))
```

Como hay un problema con los "tickers" de Wikipedia acudimos directamente a Yahoo:

```{r}
# get the URL for the wikipedia page with all IBEX35 symbols
url <- "https://finance.yahoo.com/quote/%5EIBEX/components?p=%5EIBEX"
# use that URL to scrape the SP500 table using rvest
symbols <- url %>%
  # read the HTML from the webpage
  read_html() %>%
  # to get table
  html_nodes(xpath='//*[@id="Col1-0-Components-Proxy"]/section') %>%
  html_table()
#create a list of tickers
IBEX35_Top30 <- symbols [[1]]
```


```{r}
symbols = IBEX35_Top30$Symbol
# define a function that retunrs OHLC data with the ticker name
get_symbols = function(ticker = "CABK.MC"){
  df = tq_get(ticker, from = date)  %>%  mutate(symbol = rep(ticker, length(date)))
  return(df)
}
# create the dataframe of IBEX35-Top 30 data by interating over our list of symbols and call our get symbols function each time
# the map function accomplishes this

tickers_df = map(symbols, get_symbols) %>% bind_rows()

tickers_df_plus = tickers_df %>% 
  # left join with wikipedia data
  left_join(IBEX35_Top30, by = c('symbol' = 'Symbol')) %>% 
  # make names R compatible
  clean_names() %>% 
  # keep only the columns we need
  select(symbol:company_name)
#
tickers_df_plus %>% head()
tickers_df_plus %>% tail()
#
tickers_df_plus %>%
# select just the symbol column
select(symbol)%>%
# get the distinct values
distinct()%>%
# count the distinct values
count() %>%
# we can use select to rename columns
select("Total Number of Tickers" = n)

#
Rows = dim(tickers_df_plus)[1]
Columns = dim(tickers_df_plus)[2]
dimensions = data.frame(Rows, Columns)
print(dimensions)
```

Análisis de de una compañia individual (poner el nombre de la compañia en el ticker)

```{r}
ticker = "CABK.MC"
tickers_df_plus %>% 
  filter(symbol == !!ticker) %>% 
  ggplot(aes(date, adjusted))+
  facet_wrap(~company_name)+
  geom_line()
```

```{r}
daily_returns = tickers_df_plus %>% group_by(company_name, symbol) %>% 
tq_transmute(select     = adjusted, 
              mutate_fun = periodReturn, 
              period     = "daily")
daily_returns$daily.returns <- (daily_returns$daily.returns)*100
```

```{r}
avg_return = daily_returns %>% 
  group_by(company_name, symbol) %>% 
  summarise(avg_Return = round(mean(daily.returns), 4), Volatility = round(sd(daily.returns), 4)) %>%
  arrange(desc(avg_Return), desc(Volatility))
avg_return %>% head(n=25)
avg_return %>% tail(n=25)
```

The winners:

```{r}
avg_return %>% head(25) %>% ggplot(aes(reorder(company_name, -avg_Return), avg_Return, fill = avg_Return))+
  geom_col()+
  coord_flip()+
  labs(title = "Highest Average Returns in IBEX35-Top30 over Last 6 Months", x = "Security", y = "Average Return")+
  theme_classic()+
  theme(legend.position="none")
```

The losers:

```{r}
avg_return %>% tail(25) %>% ggplot(aes(reorder(company_name, avg_Return), avg_Return, fill = avg_Return))+
    geom_col()+
    coord_flip()+
    labs(title = "Lowest Average Returns in IBEX35-Top30 over Last 6 Months", x = "Security", y = "Average Return")+
    theme_classic()+
    theme(legend.position="none")
```

Global graph:

```{r}
plot1 = avg_return %>% ggplot(aes(avg_Return, Volatility))+
  geom_text(aes(label = symbol), size = 3)+
  labs(title = "Average Return vs Volatility in IBEX35-Top30 over Last 6 Months", x = "Average Return", subtitle = "Data Source: Yahoo Finance")+
  theme_minimal()
plot1
```

Detailed analysis of the winer(s) and the loser(s):

```{r}
avg_return = avg_return %>% 
  mutate(Indicator = case_when(symbol %in% c('FDR.MC') ~ "Fluidra", symbol %in% c('PHM.MC') ~ "Pharma Mar",
                               TRUE ~ "The Rest of the IBEX35-Top30"))
plot2 = avg_return %>% ggplot(aes(avg_Return, Volatility, color = Indicator))+
  geom_text(aes(label = symbol), size = 3)+
  labs(title = "Average Return vs Volatility in IBEX35-Top30 over Last 6 Months", x = "Average Return", subtitle = "Data Source: Yahoo Finance")+
  theme_minimal()
plot2
```

```{r}
library(plotly)
p3 <- plot_ly(avg_return, x = ~avg_Return, y = ~Volatility, type = 'scatter',
        mode = 'text', text = ~symbol, textposition = 'middle right',
        color = ~Indicator, colors = 'Set1',
        textfont = list(size = 10)) %>%
  layout(title = 'Average Return vs Volatility in IBEX35-Top30 over Last 6 Months', 
         xaxis = list(title = 'Average Return', zeroline = FALSE),
         yaxis = list(title = 'Volatility'))
p3
```

```{r}
# The loser: Pharma Mar, S.A.
# Long-run (5 years) evolution of prices
symbols = c('PHM.MC')
PharmaMar = tq_get(symbols, from = '2017/01/01')
PharmaMar %>% 
  ggplot(aes(date, adjusted))+
  geom_line()+
  facet_wrap(~symbol)+
  labs(title = "Price data of Pharma Mar", subtitle = "Data Source: Yahoo Finance")+
  theme_classic()
# Recent prices (6 months)
tickers_df_plus %>% 
  filter(symbol %in% c('PHM.MC')) %>% 
  ggplot(aes(date, adjusted))+
  geom_point(alpha = 0.3, color = 'black')+
  geom_line()+
  facet_wrap(~symbol)+
  labs(title = "Price data of Pharma Mar", subtitle = "Data Source: Yahoo Finance")+
  theme_classic()
```

```{r}
# The winner: Fluidra, S.A.
# Long-run (5 years) evolution of prices
symbols = c('FDR.MC')
Moderna = tq_get(symbols, from = '2017/01/01')
Moderna %>% 
  ggplot(aes(date, adjusted))+
  geom_line()+
  facet_wrap(~symbol)+
  labs(title = "Price data of Fluidra", subtitle = "Data Source: Yahoo Finance")+
  theme_classic()
# Recent prices (6 months)
tickers_df_plus %>% 
  filter(symbol %in% c('FDR.MC')) %>% 
  ggplot(aes(date, adjusted))+
  geom_point(alpha = 0.3, color = 'black')+
  geom_line()+
  facet_wrap(~symbol)+
  labs(title = "Price data of Fluidra", subtitle = "Data Source: Yahoo Finance")+
  theme_classic()
```
