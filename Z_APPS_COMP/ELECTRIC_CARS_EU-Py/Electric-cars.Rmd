---
title: "Price of Electric Vehicles in the European Market (https://ev-database.org/)"
output: html_notebook
---

```{python}
import numpy as np
import pandas as pd 
import matplotlib.pyplot as plt
import seaborn as sns
#
df1= pd.read_csv("EU_Electric_vehicles.csv")
df1.info()
df1.head()
print(df1.columns.tolist())
#
# Preparing and cleaning the data
#
# filling empty data with 0
df1=df1.fillna('0')
# get the name of the car manufacturer from the car name
df1['Manufacturer'] = df1.Name.str.split(' ', 1, expand=True)[0]
# removing currency sign
PriceinUK=[]
for item in df1['PriceinUK']:
    PriceinUK+=[int(item.replace('£','').replace(',',''))]
df1['PriceinUK']=PriceinUK
#
PriceinGermany=[]
for item in df1['PriceinGermany']:
    PriceinGermany+=[int(item.replace('€','').replace(',',''))]
df1['PriceinGermany']=PriceinGermany
# Preparing the data  
FastChargeSpeed=[]
for item in df1['FastChargeSpeed']:
    FastChargeSpeed+=[int(item.replace(' km/h','').replace('-','0'))]
df1['FastChargeSpeed']=FastChargeSpeed
# 
Efficiency=[]
for item in df1['Efficiency']:
    Efficiency+=[int(item.replace(' Wh/km',''))]
df1['Efficiency']=Efficiency
#
Range=[]
for item in df1['Range']:
    Range+=[int(item.replace(' km',''))]
df1['Range']=Range
#
TopSpeed=[]
for item in df1['TopSpeed']:
    TopSpeed+=[int(item.replace(' km/h',''))]
df1['TopSpeed']=TopSpeed
#
Acceleration=[]
for item in df1['Acceleration']:
    Acceleration+=[float(item.replace(' sec',''))]
df1['Acceleration']=Acceleration
#
Subtitle=[]
for item in df1['Subtitle']:
    Subtitle+=[float(item.replace('Battery Electric Vehicle | ','').replace(' kWh','').replace('      ',''))]
df1['Subtitle']=Subtitle
#
df1= df1.rename(columns = {'Subtitle':'KWH'})
df1.info()
df1.head()
#
df1.corr()
plt.figure(figsize=(8,6))
sns.heatmap(df1.corr(), annot=True)
plt.show()
# count of each type of drive for the vehicles
sns.countplot(x = 'Drive', data = df1)
plt.show()
#  distribution of the number of seats
sns.countplot(x = 'NumberofSeats', data = df1)
plt.show()
# data distribution considering both, the number of seats and type of drive
plt.figure(figsize=(8,6))
sns.countplot(x = 'NumberofSeats', hue='Drive', data=df1)
plt.show()
# car manufacturers
plt.figure(figsize=(18,10))
sns.countplot(y = 'Manufacturer', data = df1)
# 
# scatter relation plots to understand the data distribution
#
# relation between acceleration and KWH capacity
sns.relplot(x="KWH", y="Acceleration", height=6,hue="Drive",data=df1)
# add the factor of the number of seats
sns.relplot(x="KWH", y="Acceleration", size="NumberofSeats", height=6,sizes=(15, 100),data=df1)
# relation between Top Speed and Vehicle Range
sns.relplot(x="TopSpeed", y="Range",height=6, hue="Drive",data=df1)
# relationship between Fast Charge Speed and Efficiency
sns.relplot(x="FastChargeSpeed", y="Efficiency", height=6,data=df1)
# joint plot type
sns.jointplot(x=df1["KWH"], y=df1["Range"], kind="hex", color="#4CB391")
sns.jointplot(x=df1["KWH"], y=df1["Efficiency"], kind="hex", color="#4CB391")
#
sns.pairplot(df1[["KWH","Acceleration","TopSpeed","Range","FastChargeSpeed"]])
#
# Machine Learning Model For Price Prediction of Electric Vehicles
#
df1.head()
# We will predict the price of the vehicle based on all the parameters and data
# One thing to be pointed is that many data points are missing. 
# Let us take only the prices in UK Pound.
# Considering 1 Euro = 0.85 Pound
c=0
for i in range(0, len(df1["PriceinUK"])):
    if (df1["PriceinUK"][i]==0):
        c+=1
print('Empty Values:',c)
#
pd.options.mode.chained_assignment = None
for i in range(0, len(df1["PriceinUK"])):
    if (df1["PriceinUK"][i]==0):
        val=df1["PriceinGermany"][i]*0.85
        df1["PriceinUK"][i]=val
df1.head()
# ML
import category_encoders as ce
train_df=df1
# create object of Ordinal encoding
encoder= ce.OrdinalEncoder(cols=['Drive'],return_df=True,
                           mapping=[{'col':'Drive',
'mapping':{'Front Wheel Drive':1,'Rear Wheel Drive':2,'All Wheel Drive':3}}])
df1.head()
# Fit and transform train data 
df_train = encoder.fit_transform(train_df) #Original data
df_train.head()
df_train.info()
#
X= df_train.drop(['Name', 'PriceinGermany','PriceinUK','Manufacturer'], axis=1)
X=X.values
X
y=df_train['PriceinUK'].values
y
X.shape
y.shape
from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=7)
from sklearn.ensemble import RandomForestRegressor
# create regressor object
regressor = RandomForestRegressor(n_estimators = 300, random_state = 0)
# fit the regressor with x and y data
regressor.fit(X_train, y_train)
y_pred= regressor.predict(X_test)
y_test
y_pred
#Mean Absolute Error(MAE)
from sklearn.metrics import mean_absolute_error
print("MAE: ",mean_absolute_error(y_test,y_pred))
#Mean Squared Error(MSE)
from sklearn.metrics import mean_squared_error
print("MSE: ",mean_squared_error(y_test,y_pred))
#Root Mean Squared Error(RMSE)
print("RMSE: ",np.sqrt(mean_squared_error(y_test,y_pred)))
#R Squared (R2)
from sklearn.metrics import r2_score
r2 = r2_score(y_test,y_pred)
print("R2: ",r2)
#
```

