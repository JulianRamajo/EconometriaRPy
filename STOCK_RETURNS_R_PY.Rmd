---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---
## R analysis

```{r}
# SET UP
#
library(tidyverse)
library(lubridate)
library(scales)
# DATA
#
stock_data<-read_csv("sp500_45.csv")
# filter MSFT
MSFT <- stock_data %>% filter(ticker == "MSFT")

# MSFT price
p_MSFT <-MSFT %>% select(ref.date,price.close) %>% rename(date=ref.date)

# ready_sp500_index.csv
SP500<-read_csv("sp500_index.csv")

# SP500 index
p_SP500 <- SP500 %>% select(ref.date,price.close) %>% rename(date=ref.date)

# JOIN by date
data_daily <- inner_join(p_SP500,p_MSFT,by="date") %>% rename(p_SP500=price.close.x,p_MSFT=price.close.y)

# FILTER ("31/12/1997","DMY") to ("31/12/2018","DMY")
data_daily <- data_daily %>% filter(date>="1997-12-31" & date<="2018-12-31") 
# 21ys + last day of 1997
data_daily <- data_daily %>% mutate(year = year(date),month=month(date))

# ANALYSIS
#
#   Graphs
data_daily<- data_daily %>% mutate(lnp_MSFT=log(p_MSFT),lnp_SP500=log(p_SP500))

p1<-ggplot(data=data_daily,aes(x=date)) +
  geom_line(aes(y = p_MSFT), size = 0.5)+
  scale_y_continuous(expand = c(0.01,0.01),limits = c(0,120), breaks = seq(0,120,20)) +  
  scale_x_date(breaks = as.Date(c("1998-01-01","2002-01-01","2006-01-01","2010-01-01","2014-01-01","2018-01-01")),
               limits = as.Date(c("1998-01-01","2018-12-31")), labels = date_format("1%b%Y"),
               minor_breaks = "1 year") +
  labs(y = "Microsoft stock price (US dollars)",x= "Date (day)")
p1

p2<-ggplot(data=data_daily,aes(x=date)) +
  geom_line(aes(y = p_SP500), size = 0.5)+
  scale_y_continuous(limits = c(500,3000), breaks = seq(500,3000,500)) +  
  scale_x_date(breaks = as.Date(c("1998-01-01","2002-01-01","2006-01-01","2010-01-01","2014-01-01","2018-01-01")),
               limits = as.Date(c("1998-01-01","2018-12-31")), labels = date_format("1%b%Y"),
               minor_breaks = "1 year") +
  labs(y = "S&P 500 stock market index",x= "Date (day)")
p2

#

data_daily <- data_daily %>% 
            mutate(l.p_MSFT=lag(p_MSFT),l.p_SP500=lag(p_SP500)) %>% 
            mutate(d.p_MSFT=p_MSFT-l.p_MSFT,d.p_SP500=p_SP500-l.p_SP500)

data_daily <- data_daily %>% mutate(PctRetMSFT=(d.p_MSFT/l.p_MSFT)*100, PctRetSP500=(d.p_SP500/l.p_SP500)*100)


p3 <- ggplot(data_daily, aes(x=PctRetSP500,y=PctRetMSFT)) + 
               geom_point() +  
               stat_smooth(method=lm) +  
               labs(x="S&P500 index daily returns (percent)",y="Microsoft stock daily returns (percent)")

p3
#   Regression
#  
reg <- lm(PctRetMSFT ~ PctRetSP500, data=data_daily)
summary(reg)
# 
```

## Python analysis

```{python}
# SET UP
import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf
from plotnine import *
from datetime import datetime
import matplotlib.pyplot as plt

# DATA
stock_data = pd.read_csv("sp500_45.csv")
stock_data.head()
MSFT = stock_data[stock_data['ticker']=='MSFT']
p_MSFT = MSFT[['ref.date','price.close']]. \
    rename(columns={'ref.date':'date'}). \
    reset_index(drop=True)
p_MSFT['date']=pd.to_datetime(p_MSFT['date'])
p_MSFT.head()

sp500_index = pd.read_csv("sp500_index.csv")
p_SP500 = sp500_index[['ref.date','price.close']]. \
    rename(columns={'ref.date':'date'}). \
    reset_index(drop=True)
p_SP500['date']=pd.to_datetime(p_SP500['date'])
p_SP500.head()
# JOIN
data_daily=pd.merge(p_SP500,p_MSFT,how='inner',on='date').\
    rename(columns={'price.close_x':'p_SP500','price.close_y':'p_MSFT'})
data_daily = data_daily[(data_daily['date']>='1997-12-31') & \
                            (data_daily['date']<='2018-12-31')] 
data_daily['year'] = data_daily['date'].dt.year
data_daily['month'] = data_daily['date'].dt.month
#
data_daily['lnp_MSFT']=data_daily['p_MSFT'].map(lambda x:np.log(x))
data_daily['lnp_SP500']=data_daily['p_SP500'].map(lambda x:np.log(x))

(ggplot(data_daily) 
        + geom_line(aes('date','p_MSFT'), size = 0.5) 
        + scale_y_continuous(expand = [0.01,0.01],limits = [0,120]) 
        + labs(y = "Microsoft stock price (US dollars)",x= "Date (day)") 
        + theme_bw())

(ggplot(data_daily) 
        + geom_line(aes('date','p_SP500'), size = 0.5) 
        + scale_y_continuous(expand = [0.01,0.01]) 
        + labs(y = "SP500 index",x= "Date (day)") 
        + theme_bw())

data_daily['l.p_MSFT'] = data_daily['p_MSFT'].shift()
data_daily['l.p_SP500'] = data_daily['p_SP500'].shift()
data_daily['d.p_MSFT'] = data_daily['p_MSFT'] - data_daily['l.p_MSFT']
data_daily['d.p_SP500'] = data_daily['p_SP500'] - data_daily['l.p_SP500']
data_daily['PctRetMSFT'] = data_daily['d.p_MSFT']/data_daily['l.p_MSFT']*100
data_daily['PctRetSP500'] = data_daily['d.p_SP500']/data_daily['l.p_SP500']*100
data_daily.head()

(ggplot(data_daily,aes('PctRetSP500','PctRetMSFT'))
  + geom_point()
  + geom_smooth(method='lm',se=False)
  + labs(x="S&P500 index daily returns (percent)",y="Microsoft stock daily returns (percent)")
  + theme_bw())

reg = smf.ols('PctRetMSFT ~ PctRetSP500', data=data_daily).fit()
print(reg.summary())

```

