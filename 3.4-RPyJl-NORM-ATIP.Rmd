---
title: 'TEMA 3: No normalidad de los errores y observaciones atípicas'
author:
  name: Julián Ramajo, ramajo@unex.es
  affiliation: GRADO EN ESTADÍSTICA | ECONOMETRIA (502243)
subtitle: 'Aplicación 3.4: Análisis de la hipótesis de  normalidad y de la presencia de atípicos con datos simulados'
output:
  html_document:
    theme: journal
    highlight: haddock
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

# Objetivo

En esta aplicación se tratará el tema de la no normalidad de los erroes causada por la presencia de observaciones atípicas, y se propondrán estimadores que son 'robustos' ante la presencia de dichos datos en la base muestral.

# Resultados R

```{r, message=FALSE}
# Librerías
library(tidyverse)
library(car)
library(lmtest)
library(quantreg)
library(MASS)
library(moments)
library(tseries)
# Datos
ATIP <- read_csv("ATIP.csv")
summary(ATIP)
# Gráficas
# Diagrama de puntos
ggplot(ATIP, aes(x=X, y=Y)) + geom_point() + labs(title="Diagrama de puntos", x="X", y="Y")
# Modelo de regresión lineal
summary(lm_YX <- lm(Y ~ X, data = ATIP))
plot(Y ~ X , data=ATIP)
abline(lm_YX)
# Gráficas de diagnóstico estándar de la regresión MCO
par(mfrow=c(2,2))
plot(lm_YX)
# ¿Qué pasa si se eliminan las tres observaciones atípicas?
summary(M1 <- lm(Y ~ X, data = ATIP))
summary(M2 <- lm(Y ~ X, data = ATIP[1:19,]))
compareCoefs(M1,M2)
#
plot(Y ~ X , data=ATIP)
abline(M1)
abline(M2, lty=2)
legend("topleft", c("Datos completos (M1)", "Datos recortados (M2)"), lty = c(1, 2), bty = "n")
# Distribución de los errores del modelo
par(mfrow=c(1,1))
hist(lm_YX$residuals, main = "")
box()
#
densityPlot(residuals(lm_YX))
densityPlot(rstudent(lm_YX))
#
qqnorm(residuals(lm_YX))
qqline(residuals(lm_YX))
qqPlot(lm_YX, distribution="norm")
# Contrastes de normalidad
r <- resid(lm_YX)
rbar <- mean(r)
sdr <- sd(r)
hist(lm_YX$residuals, col="grey", freq=FALSE, main="Distribución de los residuos", ylab="Densidad estimada", xlab="residuos")
curve(dnorm(x, rbar, sdr), col=2, add=TRUE, ylab="Density", xlab="r")
# Librería moments
skewness(lm_YX$residuals)
kurtosis(lm_YX$residuals)
agostino.test(lm_YX$residuals)
anscombe.test(lm_YX$residuals)
jarque.test(lm_YX$residuals)
# librería tseries
jarque.bera.test(lm_YX$residuals)
shapiro.test(lm_YX$residuals)
ks.test(lm_YX$residuals, pnorm)
# Detección de observaciones atípicas
# Observaciones atípicas en las variables explicativas (leverages <-> apalancamiento)
hat <- hatvalues(lm_YX)
summary(hat)
which(hat > 2 * mean(hat))
plot(hat)
abline(h = mean(hat), col = 4)
abline(h = 2 * mean(hat), col = 2)
id <- which(hat > 2 * mean(hat))
text(id, hat[id], rownames(ATIP)[id], pos = 1, xpd = TRUE)
# Observaciones atípicas en la variable dependiente (outliers)
slm_YX <- summary(lm_YX)
# Residuos estandarizados
r <- lm_YX$residuals/slm_YX$sigma
summary(r)
densityPlot(r)
which(abs(r) > 2.5)
plot(r)
abline(h = c(0,-2.5, 2.5), col = 4)
id <- which(abs(r) > 2.5)
text(id, r[id], rownames(ATIP)[id], pos = 1, xpd = TRUE)
# Residuos estudentizados (internamente)
rs <- rstandard(lm_YX)
summary(rs)
densityPlot(rs)
which(abs(rs) > 2)
plot(rs)
abline(h = c(0,-2, 2)*sd(rs), col = 4)
id <- which(abs(r) > 2*sd(rs))
text(id, r[id], rownames(ATIP)[id], pos = 1, xpd = TRUE)
# Residuos estudentizados (externamente)
rt <- rstudent(lm_YX)
rt
densityPlot(rt)
qqPlot(lm_YX)
outlierTest(lm_YX)
# Medidas de diagnóstico específicas
# Observaciones influyentes: cálculo de DFBETAS_i, DFFITS_i, COVRATIO_i, DCOOK_i y h_i
# La columna inf señala observaciones inusuales para al menos una medida
#
influence.measures(lm_YX)
S(influence.measures(lm_YX))
influenceIndexPlot(lm_YX, vars=c("hat", "Studentized","Cook"))
influencePlot(lm_YX, xlab="Hat values")
# Medidas individuales
hat <- hatvalues(lm_YX)
dfbetas <-  dfbetas(lm_YX)
dffits <-  dffits(lm_YX)
dcook <-  cooks.distance(lm_YX)
hat ; dfbetas ; dffits; dcook
#
max(hatvalues(lm_YX))
which.max(hatvalues(lm_YX))
#
max(abs(dffits(lm_YX)))
which.max(abs(dffits(lm_YX)))
#
max(cooks.distance(lm_YX))
which.max(cooks.distance(lm_YX))
#
avPlots(lm_YX, id=list(cex=0.60, method="mahal")) # Gráficos de variable añadida, buscando casos influyentes
# Estimaciones robustas
# Regresión cuartilítica
summary(lm_YX <- lm(Y ~ X, data = ATIP))
summary(qr_YX <- rq(Y ~ X, data = ATIP)) # tau=0.5
#
plot(Y ~ X , data=ATIP)
abline(lm_YX)
abline(qr_YX, lty=2)
legend("topleft", c("Regresión MCO", "Regresión DAM"), lty = c(1, 2), bty = "n")
# tau secuencial
S(qr_YX <- rq(Y ~ X, data = ATIP, tau=seq(0.1,0.9,0.1)))
plot(summary(qr_YX), level=0.95)
# tau discreto
S(qr_YX <- rq(Y ~ X, tau = c(0.25, 0.50, 0.75), data = ATIP))
plot(qr_YX)
# Estimadores M y MM
summary(lm_YX <- lm(Y ~ X, data = ATIP))
summary(rlm_YX <- rlm(Y ~ X, data = ATIP, method="MM")) # Para usar el estimador M usar method="M"
#
plot(Y ~ X , data=ATIP)
abline(lm_YX)
abline(rlm_YX, lty=2)
legend("topleft", c("Regresión MCO", "Regresión MM"), lty = c(1, 2), bty = "n")
```
