---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

# R code

```{r}
library(readxl)
macro <- read_excel("~/Dropbox/Mi Mac (Mac Pro de Julián)/Documents/GitHub/EcoMetricsRPy/APT.xls")
head(macro)
#
macro$dspread = c(NA,diff(macro$BMINUSA))
macro$dcredit = c(NA,diff(macro$CCREDIT))
macro$dprod = c(NA,diff(macro$INDPRO))
macro$dmoney = c(NA,diff(macro$M1SUPPLY))
macro$inflation = c(NA,100*diff(log(macro$CPI)))
macro$rterm = c(NA,diff(macro$USTB10Y-macro$USTB3M))
macro$dinflation = c(NA,100*diff(macro$inflation))
macro$r_sp = c(NA,100*diff(log(macro$SANDP)))
macro$er_sp = c(NA,100*diff(log(macro$SANDP)))-macro$USTB3M/12
macro$er_msoft = c(NA,100*diff(log(macro$MICROSOFT)))-macro$USTB3M/12
#
library(ivreg)
inf_iv = ivreg(inflation ~ r_sp + dprod + dcredit + dmoney |
                 dcredit + dprod + rterm + dspread + dmoney, data = macro)
summary(inf_iv)
ret_iv = ivreg(r_sp ~ inflation + dprod + dspread + rterm |
                 dcredit + dprod + rterm + dspread + dmoney, data = macro)
summary(ret_iv)
#
# Test de Hausman
#
inf_ols = lm(inflation ~ dprod + dspread + rterm +  dcredit + dmoney, data = macro)
ret_ols = lm(r_sp ~ dprod + dspread + rterm +  dcredit + dmoney, data = macro)
#
macro$inf_fit = c(NA,inf_ols$fitted.values)
macro$ret_fit = c(NA,ret_ols$fitted.values)
#
summary(lm(inflation ~ dprod + dcredit + dmoney + r_sp + ret_fit, data = macro))
summary(lm(r_sp ~ dprod + dspread + rterm + inflation + inf_fit, data = macro))
```

# Python code

```{python}
import pandas as pd
import numpy as np
import statsmodels.api as sm
import statsmodels.formula.api as smf
import statsmodels.stats.api as sms
from statsmodels.stats.diagnostic import het_arch
from statsmodels.stats.outliers_influence import reset_ramsey
from statsmodels.compat import lzip
import scipy.stats as scs
import matplotlib.pyplot as plt
from linearmodels import IV2SLS
from linearmodels.system import IVSystemGMM
from linearmodels.iv import IVGMM
#
data = pd.read_excel('~/Dropbox/Mi Mac (Mac Pro de Julián)/Documents/GitHub/EcoMetricsRPy/APT.xls', index_col=0)
data.head()
#
def LogDiff(x):
    x_diff = 100*np.log(x/x.shift(1))
    return x_diff
data = pd.DataFrame({'dspread' : data['BMINUSA'] - data['BMINUSA'].shift(1),
                    'dcredit' : data['CCREDIT'] - data['CCREDIT'].shift(1),
                    'dprod' : data['INDPRO'] - data['INDPRO'].shift(1),
                    'r_msoft' : LogDiff(data['MICROSOFT']),
                    'r_sp' : LogDiff(data['SANDP']),
                    'dmoney' : data['M1SUPPLY'] - data['M1SUPPLY'].shift(1),
                    'inflation' : LogDiff(data['CPI']),
                    'term' : data['USTB10Y'] - data['USTB3M'],
                    'dinflation' : LogDiff(data['CPI']) - LogDiff(data['CPI']).shift(1),
                    'mustb3m' : data['USTB3M']/12,
                    'rterm' : (data['USTB10Y'] - data['USTB3M']) - (data['USTB10Y'] - data['USTB3M']).shift(1),
                    'er_msoft' : LogDiff(data['MICROSOFT']) - data['USTB3M']/12,
                    'er_sp' : LogDiff(data['SANDP']) - data['USTB3M']/12})
# data.head()
# data = data.dropna()
# 2SLS
#
# Ecuación 1
data = sm.add_constant(data)
ivmod = IV2SLS(dependent = data.inflation,
               exog = data[['const','dprod','dcredit','dmoney']],
               endog = data.r_sp,
               instruments = data[['rterm','dspread']])
res_2sls1 = ivmod.fit(cov_type='unadjusted')
print(res_2sls1)
# Ecuación 2
ivmod = IV2SLS(dependent = data.r_sp,
               exog = data[['const','dprod','dspread','rterm']],
               endog = data.inflation,
               instruments = data[['dcredit','dmoney']])
res_2sls2 = ivmod.fit(cov_type='unadjusted')
print(res_2sls2)
#
# GMM
#
# Ecuación 1
formula = 'inflation ~ 1 + dprod + dcredit + dmoney + [r_sp ~ rterm + dspread]'
mod = IVGMM.from_formula(formula, data, weight_type='unadjusted')
res1 = mod.fit(cov_type='robust')
print(res1.summary)
# Ecuación 2
formula = 'r_sp ~ 1 + dprod + dspread + rterm + [inflation ~ dcredit + dmoney]'
mod = IVGMM.from_formula(formula, data, weight_type='unadjusted')
res2 = mod.fit(cov_type='robust')
print(res2.summary)
```
