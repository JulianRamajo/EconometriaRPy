---
title: 'TEMA 2: Series temporales de alta frecuencia y estacionalidad'
author:
  name: Julián Ramajo, ramajo@unex.es
  affiliation: GRADO EN ESTADÍSTICA | ECONOMETRIA (502243)
subtitle: 'Aplicación 2.6: Demanda de electricidad en el estado de Victoria, Australia'
output:
  html_document:
    theme: journal
    highlight: haddock
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

# Objetivo

En esta aplicación se estimará una función de demanda de electricidad en el estado de Victoria, en Australia. Se explicará el consumo de electricidad en función de la temperatura y de otras variables de control, usando datos semi-horarios (cada media hora) para el período 2012-2014.

# Código R

```{r, message=FALSE}
# Lectura de librerías
library(tidyverse)
library(car)
library(lmtest)
library(fpp3)
# Lectura de datos
load("DEM_ELEC.RData")
class(dem_elec_vict)
# Demanda de electricidad 2012-2014
dem_elec_vict %>% 
  autoplot(Demanda) +
  labs(title = "Demanda de electricidad (cada media hora, en MW)", subtitle = "Victoria-Australia")
# Estacionalidad(es) en la demanda: diaria, semanal y anual
dem_elec_vict %>% gg_season(Demanda, period="day") + theme(legend.position = "none")
dem_elec_vict %>% gg_season(Demanda, period="week") + theme(legend.position = "none")
dem_elec_vict %>% gg_season(Demanda, period="year")
# Consumo y temperatura en el período 2012-2014
dem_elec_vict %>%
  pivot_longer(Demanda:Temperatura, names_to = "Series") %>%
  ggplot(aes(x = Time, y = value)) +
  geom_line() +
  facet_grid(rows = vars(Series), scales = "free_y") +
  labs(y = "")
# Consumo versus temperatura
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Comportamiento en días festivos
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda, col=Fiesta)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Comportamiento en días laborables
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda, col=Dia_lab)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Comportamiento por día de la semana
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda, col=Dia_sem)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Comportamiento en días de frío (< 18ºC)
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda, col=Frio)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Comportamiento en días de calor (> 28ºC)
dem_elec_vict %>%
  ggplot(aes(x = Temperatura, y = Demanda, col=Calor)) +
  geom_point() +
  ylab("Demanda (MWh)") + xlab("Temperatura (ºC)")
# Modelo de demanda de electricidad
dem_elec <- lm(log(Demanda) ~ Temperatura + I(Temperatura^2) + Dia_sem + Dia_lab + Frio + Calor, 
               data = dem_elec_vict)
summary(dem_elec)
# Predicción de consumo para un lunes laborable, suponiendo una temparatura media de 26ª
# (podrían usarse predicciones del servicio de meteorología)
Xs_1d <- new_data(dem_elec_vict, 1) %>%
    mutate(Temperatura = 26, Dia_sem = "lun" , Dia_lab = TRUE, Frio = FALSE, Calor = FALSE)
pred_dem_IC <- predict(dem_elec, Xs_1d[,2:6], interval = "confidence", level = 0.95)
pred_dem_IC
exp(pred_dem_IC)
#
# Anexo: Modelización de la estacionalidad múltiple -> términos de regresión armónicos
#
dem_elec_s <- dem_elec_vict %>% model(ARIMA((log(Demanda) ~ Temperatura + I(Temperatura^2) + Dia_sem + Dia_lab + Frio + Calor + PDQ(0, 0, 0) + pdq(d = 0) + fourier(period = "day", K = 10) + fourier(period = "week", K = 5) + fourier(period = "year", K = 3))))
report(dem_elec_s)
# Los residuos demuestran que aún queda mucha información por modelizar ...
dem_elec_s %>% gg_tsresiduals()
# Se puede consultar el siguiente artículo para ver una ampliación del modelo:
# Fan, S., y Hyndman, R.J. (2012): "Short-term load forecasting based on a semi-parametric additive model", IEEE Transactions on Power Systems, 27(1), 134–141. [https://doi.org/10.1109/TPWRS.2011.2162082]
# Entre otras cosas, podrían introducirse los valores de demanda recientes (intra-día y entre-días) para captar el comportamiento dinámico de la demanda:
dem_elec_d <- dem_elec_vict %>% model(TSLM(log(Demanda) ~ lag(log(Demanda), 1) + lag(log(Demanda), 2) + lag(log(Demanda), 3) + lag(log(Demanda), 4) + lag(log(Demanda), 48) + lag(log(Demanda), 2*48) + Temperatura + I(Temperatura^2) + Dia_sem + Dia_lab + Frio + Calor)) %>% report()
```

# Código Python

```{python, message=FALSE}
# Lectura de librerías
import numpy as np
import pandas as pd
import statsmodels.stats.api as sms
import statsmodels.formula.api as smf
import scipy as sp
import matplotlib.pyplot as plt
import seaborn as sns
# Lectura de datos
dem_elec_vict = pd.read_csv('DEM_ELEC.csv', index_col=0)
# ´Gráfica consumo versus temperatura
plt.figure(3)
plt.scatter(dem_elec_vict['Temperatura'], dem_elec_vict['Demanda'])
plt.xlabel('Temperatura')
plt.ylabel('Demanda')
plt.title('Consumo electricidad versus temperatura')
plt.grid(True)
plt.show()
# Modelo básico de demanda de electricidad
dem_elec = smf.ols('np.log(Demanda) ~ Temperatura + np.power(Temperatura,2) + Dia_sem + Dia_lab + Frio + Calor', data=dem_elec_vict).fit()
print(dem_elec.summary())
```
